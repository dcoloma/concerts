<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title>Concert Guide</title>

  <!--<script defer src="scripts/l10n.js" charset="utf-8"></script>
  <link rel="resource" type="application/l10n" href="locales/locales.ini" />-->
    <link href="style/base.css" rel="stylesheet" type="text/css">

  <link href="bb/toolbars.css" rel="stylesheet" type="text/css">
  <link href="bb/tabs.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" charset="utf-8" src="http://maps.google.com/maps/api/js?sensor=true"></script>

  <link href="bb/icons/styles/action_icons.css" rel="stylesheet" type="text/css">
  <link href="bb/icons/styles/settings_icons.css" rel="stylesheet" type="text/css">
  <link href="bb/icons/styles/comms_icons.css" rel="stylesheet" type="text/css">
  <link href="bb/buttons.css" rel="stylesheet" type="text/css">
  <link href="bb/icons/styles/media_icons.css" rel="stylesheet" type="text/css">
  <link href="bb/icons/styles/settings_icons.css" rel="stylesheet" type="text/css">
  <link href="bb/action_menu.css" rel="stylesheet" type="text/css">
  <link href="bb/input_areas.css" rel="stylesheet" type="text/css">
  <link href="bb/headers.css" rel="stylesheet" type="text/css">
  <link href="bb/lists.css" rel="stylesheet" type="text/css">
  <link href="bb/confirm.css" rel="stylesheet" type="text/css">
  <link href="bb/status.css" rel="stylesheet" type="text/css">

  <script src="scripts/ajax.js"></script>
  <script src="scripts/infinite-scroll.js"></script>

<script>

  // Pagination Control
  var page = 1; // current page for last.fm requests
  var newPage = 1;  // next page for last.fm reqeusts
  var totalPages = 1; // total number of pages in last.fm answer
  var lastPage = false; // are we on the last page

  // Global Attributes  
  var userLat = 41.64; // user's current latitude or null if they searched by city
  var userLng = -0.88; // user's current longitude or null if they searched by city
  var radio=25; // radio de bÃºsqueda en km
  var amount=25;
  var artist=""
  var list = "";
  var city = "";
  var pages; // pages to be displayed for gig details
  var tweets;
  var mails;
  var smss;
  var lastPosition;

  var typeSearch = "locationManual"; // 'locationManual', 'locationAutomatic', 'artist'

  var baseUrl = "http://ws.audioscrobbler.com/2.0/?method=geo.getevents&api_key=a0794c9653eaeb2f94ad10bb53fc5ea8&format=json&distance=" + radio + "&limit=" + amount;
  var baseUrlartist = "http://ws.audioscrobbler.com/2.0/?method=artist.getevents&api_key=a0794c9653eaeb2f94ad10bb53fc5ea8&format=json&autocorrect=1";

  // Prepares paging, it should be invoked every time a new XHR has been
  // successfully performed. The idea is to identify if we are already
  // in the last page and identify what is the next page (if any)
  function prepareNextPage(currentPage, totalPages)
  {
    page = parseInt(currentPage);
    totalPages = parseInt(totalPages);
    newPage = page + 1;
    if (newPage > totalPages)
    { 
      newPage = totalPages;
      lastPage = true;
    }     
    else
    {
      lastPage = false;
    }
  }

  function showBanner(message)
  {
    document.getElementById("status-banner-text").innerHTML = message;
    document.getElementById("status-banner").classList.remove('hidden');
    setTimeout(function(){document.getElementById("status-banner").classList.add('hidden')},5000);
  }

  function errorResponse(message)
  {
    console.log("error in AJAX request: " + message);
    document.getElementById(list).innerHTML="";
    showBanner("Error Requesting the concerts to last.fm (" + message +")")
  }

 function getGigsByArtist(e)
 {
   console.log("getGigsByArtist");
   artist = document.getElementById("main-page-artist-view-searchbox").value;
   typeSearch="artist";
   if (e != undefined)
     var key=e.keyCode || e.which;
   else
     key=13;
   if (key==13){
     url = baseUrlartist + "&artist=" + encodeURI(artist) + encodeURI("&page=") + encodeURI(newPage);
     console.log("XXX " + url);
     list = "main-page-artist-event-list"
     getGigs(url);
   }
 }

  function getGigsByLocation(e)
  {
    console.log("getGigsByLocation");
    city = document.getElementById("main-page-location-view-searchbox").value;
    typeSearch="locationManual";
   if (e != undefined)
     var key=e.keyCode || e.which;
   else
     key=13;    
     if (key==13){
      url = baseUrl + "&location=" + encodeURI(city) + encodeURI("&page=") + encodeURI(newPage);
      console.log("XXX " + url);
      list = "main-page-location-event-list"
      getGigs(url);
    }
  }

  function requestLocation(){
    console.log("requestLocation")
    try {
      navigator.geolocation.getCurrentPosition(onposition, onpositionerror, {timeout:10000, maximumAge:120000});
      document.getElementById("main-page-location-view-searchbox").value = "Getting your location...";
    } catch(e) {
      onpositionerror(e);
    }
  }


  function onposition(position){
    console.log("Location Retrieved Successfully: onposition");
             
    if(position != null){
      userLat = position.coords.latitude;
      userLng = position.coords.longitude;
      lastPosition = position;
      console.log("With coordinates " + userLat + "," + userLng);
      document.getElementById("main-page-location-view-searchbox").value = userLat + " , " + userLng;
      // intentamos saber la correspodencia a localidad
      // Pedimos los conciertos
      url = baseUrl + "&lat=" + encodeURI(userLat) + "&long=" + encodeURI(userLng) + encodeURI("&page=") + encodeURI(newPage);
      console.log("XXX " + url);
      list = "main-page-location-event-list";
      typeSearch="locationAutomatic";
      getGigs(url);
      getAddressWithCoords(userLat, userLng)
   }else{
      console.log("Your position could not be retrieved, please try it again or introduce manually your location.");
      showBanner("Your position could not be retrieved, please try it again or introduce manually your location.");
    }
  }

  function onpositionerror(e)
  {
    console.log("Error while retrieving location " + e.message);
    showBanner("Your position could not be retrieved, please try it again or introduce it manually (" + e.message + ")");
  }

  function getAddressWithCoords(lat, lng)
  {
    var latlng = new google.maps.LatLng(lat, lng);
    geocoder = new google.maps.Geocoder();              
    try 
    {      
      geocoder.geocode({'latLng': latlng, 'language': 'es'}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) 
        {
          console.log("Geocoding OK, location obtained ");
          if (results[1]) 
          {
            console.log("Resultado " + results[2].formatted_address); 
            document.getElementById("main-page-location-view-searchbox").value = results[2].formatted_address;
            console.log("search box updated");
          } 
          else 
          {
            console.log("No address found");
          }
        } 
        else 
        {
          console.log("Impossible retrieving locality for your current location - Error code: " + status);
        }
      });
    }
    catch(e)
    {
      console.log("Impossible retrieving locality for your current location - Error code: " + e.message);
    }
  }  

 // Retrieves the content from last.fm for a particular page
  function getGigs(url)
  { 
    console.log("getGigs with url " + url);
    try 
    {
      console.log("URL request is " + url);
      ajaxRequest(showGigs, errorResponse, {requestType:"GET", uri:url}, "JSON");
    } 
    catch (e) 
    {
      console.log("Request Error: " + e.message);
      showBanner("Error retrieving the concerts (" + e.message +")");
    }
  }
    
  // Shows the events, to be called when the events have been retrieved
  // the input argument (data) contains the json representation of the
  // gigs received in the XHR
  function showGigs(data)
  {
    console.log("showGigs")
    // This is the current content of the event list
    text = document.getElementById(list).innerHTML;
    
    // First we check if an error has occured
    if((data.events == null) || (data.events.event == null))
    {
      console.log("ERROR while retrieving the gigs with code " + data.error + " and message " + data.message);
      showBanner("No Concerts found, are you sure you typed the Band Name right?");
      // XXX - Localize
      document.getElementById(list).innerHTML = "";
    }
    else
    {

      // check what is current and next pages and prepares following one
      prepareNextPage(data.events['@attr'].page, data.events['@attr'].totalPages);
      
      var cont = 0; // Number of items parsed

      // If it is the first page (first request, new location, refresh...) 
      // we need to clean-up the list
      if (page === 1)
      {
        text ="<ul>"; // clean-up the list
        pages = new Array(); // every element content the text of the detailed page event
        tweets = new Array(); // array for tweet pages
        mails = new Array(); // array for emails pages
        smss = new Array(); // array for sms pages
      }
      else
      {
        cont = (page-1)*amount; // Identify the position for paging next time
      }

      if (data.events.event.length == 0)
      {
        showBanner("No Concerts found, are you sure you typed the Band Name right?");
        document.getElementById("list").innerHTML = "";
      }

      // For each event the list item is build
      for (var i = 0; i < data.events.event.length; i++) 
      {
        // There are many images for every last.fm event, we need to identify 
        // which to be used, the large image will be the preferred one
        var images = data.events.event[i].image;
        var imageToUse;
      
        for (var j = 0; j < images.length; ++j) 
        {
          imageToUse = images[j]["#text"];
          if (images[j].size == "large") 
            break;
        }
      
        if (imageToUse == "")
          imageToUse = "images/default.jpg";

        // Process the date
        var tokens = data.events.event[i].startDate.split(',',3);
        var dayOfWeek = tokens[0];
        var date = tokens[1];
        tokens = date.split(' ');
        var day = tokens[1];
        var month = tokens[2];
        var year = tokens[3];
        var time = tokens[4];
        tokens = time.split(":");
        var hour = tokens[0];
        var minute = tokens[1];
           
        // Name of the venue
        var website = data.events.event[i].venue.name;
        // If there is a link to the website we include it
        if (data.events.event[i].venue.website != "")
           website = "<a href='"+ 
            data.events.event[i].venue.website + "' target='_blank'>" + 
            data.events.event[i].venue.name + "</a>";
              
        var address = "";
            
        if (data.events.event[i].venue.location.street != "")
          address += data.events.event[i].venue.location.street + ", ";  
          
        // This is the text that will be included in the gig list  
        text +="<li><aside class='pack-end'>"+
          "<img alt='placeholder' src='" + imageToUse + "'/>" + "</aside>"+
          "<a href='javascript:showDetails(" + cont + ")'>"+
          "<p class='listItem listTopLine'>" + data.events.event[i].title + "</p>" +
          "<p>" + day + " " + month + " " + year + "</p>" +
          "<p>" + data.events.event[i].venue.name + " (" + 
          data.events.event[i].venue.location.city + ")" + "</p>" + 
          "</a></li>";   
       
        // For every event we also prepare the details page to be loaded if
        // the user selects that event, and the content of the tweet and
        // e-mail buttons
        pages[cont] = "<h2 align='center'><a href='http://www.last.fm/event/" + 
                      data.events.event[i].id +"' target='_blank'>" + data.events.event[i].title + 
                      "</a> at " + website + " </h2>" +
                      "<h3 align='center'>" /*+ dayOfWeek + ", "*/ + day + " " + 
                      month + " " + year + "</h3>" + "<p align=center>"+ 
                      address + data.events.event[i].venue.location.city + ", " + 
                      data.events.event[i].venue.location.country + 
                      "</p><p align=center><a href='http://maps.google.com/?q=" + 
                      data.events.event[i].venue.location["geo:point"]["geo:lat"] + 
                      "," + data.events.event[i].venue.location["geo:point"]["geo:long"] + 
                      "' target='_blank'><img align='center' src='http://maps.google.com/maps/api/staticmap?center=" + 
                      data.events.event[i].venue.location["geo:point"]["geo:lat"] + 
                      "," + data.events.event[i].venue.location["geo:point"]["geo:long"] +
                      "&zoom=15&size=200x250&sensor=true&markers=color:blue%7Clabel:S%7C" +
                      data.events.event[i].venue.location["geo:point"]["geo:lat"] + 
                      "," + data.events.event[i].venue.location["geo:point"]["geo:long"] + 
                      "'/></a></p>";

        // Summary of the event to be displayed in the list of events
        var summary = encodeURI(data.events.event[i].artists.headliner + " in  " + 
                      data.events.event[i].venue.location.city + 
                      " (" + dayOfWeek + ", " + day + " " + month + ")");
                                     
        // For every event I will create a link to tweet it, when the tweet
        // button is clicked, this link is used
        // XXX - Localize
        tweets[cont] = "javascript:window.open('http://twitter.com/share?text=" + 
                       summary + "&url=" + encodeURI("http://www.last.fm/event/" + 
                       data.events.event[i].id) + "&via=appconcerts', '_blank');";
                  
        mails[cont] = "javascript:window.open('mailto:?body=I discovered it through the FirefoxOS Concerts application. More details about the gig are available at " + 
                      encodeURI("http://www.last.fm/event/"+data.events.event[i].id) + 
                      "&subject=" + summary +"');";

        smss[cont] = "javascript:window.open('sms:?body=" + summary + ". I discovered it through the FirefoxOS Concerts application. More details about the gig available at " + 
                      encodeURI("http://www.last.fm/event/"+ data.events.event[i].id) +"')";

        cont++;
      }
        
      text += "</ul>";

      // Replace the content of the lsit
      document.getElementById(list).innerHTML = text;
    } 
  }

  function showDetails(i)
  {
    document.getElementById("details-page-panel").innerHTML = pages[i];
    document.getElementById("details-page-toolbar-twitter").setAttribute("onclick", tweets[i]);
    document.getElementById("details-page-toolbar-sms").setAttribute("onclick", smss[i]);
    document.getElementById("details-page-toolbar-email").setAttribute("onclick", mails[i]);
    window.location.href = '#details-page';
  }

  var options = {
  distance: 50,
  callback: function(done) {
    // 1. fetch data from the server
    // 2. insert it into the document
    // 3. call done when we are done
    if (lastPage === false)
    {
      switch(typeSearch)
      {
        case "artist":
          getGigsByArtist();
          break;
        case "locationManual":
          getGigsByLocation();
          break;
        case "locationAutomatic":
          onposition(lastPosition);
          break;
      } 
    }
    done();
  }
}

// setup infinite scroll
infiniteScroll(options);

</script>


</head>

<body onload="javascript:document.getElementById('main-page-location-view').style.visibility='visible';
        document.getElementById('main-page-location-view').style.display='inline-block';
        document.getElementById('main-page-artist-view').style.visibility='hidden';
        document.getElementById('main-page-artist-view').style.display='none';">

<section class="skin-organic" role="region" id="main-page">
  <header class="fixed" id="main-page-header">
    <a href="#"><span class="icon icon-menu">refresh</span></a>
    <h1 data-l10n-id="appName">Concert Guide </h1>
  </header>
  <article id="main-page-location-view" class="content scrollable header" style="visibility: visible;">
    <section id="main-page-location-view-subheader">
      <input type="text" placeholder="Your Location" class="main-page-searchbox" id="main-page-location-view-searchbox" onkeypress="newPage=1;getGigsByLocation(event)">
      <button class="comms-icon contacts-location" id="main-page-location-view-button" onclick="newPage=1;requestLocation()"></button>
    </section>
    <section data-type="list" class="main-page-event-list view-body article-list" id="main-page-location-event-list">
    </section>
  </article>
  <article class="content scrollable header" id="main-page-artist-view">
    <input type="text" placeholder="Artist" class="main-page-searchbox" id="main-page-artist-view-searchbox" onkeypress="newPage=1;getGigsByArtist(event)">
    <section data-type="list" class="main-page-event-list view-body article-list" id="main-page-artist-event-list">
    </section>
  </article>
  <article class="tab frame">
    <div role="toolbar">
      <ul role="tablist" data-items="2" class="bottom0">
        <li><button class="comms-icon contacts-location" onclick="document.getElementById('main-page-location-view').style.visibility='visible';
        document.getElementById('main-page-location-view').style.display='inline-block';
        document.getElementById('main-page-artist-view').style.visibility='hidden';
        document.getElementById('main-page-artist-view').style.display='none';">Search by Location</button></li>
        <li><button class="comms-icon contacts-favorite" onclick="document.getElementById('main-page-artist-view').style.visibility='visible';
        document.getElementById('main-page-artist-view').style.display='inline-block';
        document.getElementById('main-page-location-view').style.visibility='hidden';
        document.getElementById('main-page-location-view').style.display='none';">Search by Artist</button></li>
      </ul>
    </div>
  </article>
  <section role="status" class="hidden" id="status-banner">
    <p id="status-banner-text"></p>
  </section>
</section>

<!-- Details Page -->
<div id="details-page" class="modalDialog">
  <section class="skin-organic" role="region">
  <header class="fixed" id="details-page-header">
    <a href="#"><span class="icon icon-close">close</span></a>
    <h1 data-l10n-id="appName">Concert Details </h1>
  </header>
  <article class="content scrollable header" id="details-page-panel">
  </article>
  <article class="tab frame">
    <div role="toolbar" id="details-page-toolbar">
      <ul>
        <li><button class="comms-icon contacts-twitter" id="details-page-toolbar-twitter"></button></li>
        <li><button class="comms-icon contacts-sms" id="details-page-toolbar-sms"></button></li>
        <li><button class="comms-icon contacts-email" id="details-page-toolbar-email"></button></li>
      </ul>
    </div>
  </article>
</div>
<!-- End of Details Page -->

</body>
</html>
